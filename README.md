 # üè¶ ChitiBank ‚Äî Sistema Bancario Educativo

 ChitiBank es una aplicaci√≥n web educativa que simula un entorno bancario para colegios. Facilita que estudiantes, padres y personal escolar interact√∫en con cuentas, transacciones y reportes bajo el control del personal docente. El objetivo es ense√±ar conceptos financieros b√°sicos (ahorro, transferencias, historial) en un entorno seguro y cerrado.

 **Principales objetivos:**
 - Ense√±anza pr√°ctica de conceptos financieros para estudiantes.
 - Control y supervisi√≥n desde un panel administrativo para docentes.
 - Flujos seguros de creaci√≥n de usuario y manejo de cuentas que evitan inconsistencias (ej. cuentas sin perfil).

 **Resumen del sistema:**
 - Frontend: Next.js con App Router + TypeScript + Tailwind CSS (shadcn/ui components).
 - Backend: Supabase Auth + Postgres + Edge Functions (Deno) para l√≥gica cr√≠tica transaccional.
 - Despliegue: Vercel (frontend) y Supabase (Edge Functions + DB).

 --

 **Tabla de contenidos**
 1. Visi√≥n general
 2. Arquitectura y stack
 3. Esquema de Base de Datos (tablas y relaciones)
 4. Migraciones y funciones almacenadas importantes
 5. Edge Functions (Supabase)
 6. Frontend: estructura, p√°ginas y componentes importantes
 7. Configuraci√≥n y despliegue (Vercel & Supabase)
 8. Desarrollo local
 9. Notas operativas y seguridad

 --

 **1) Visi√≥n general**

 ChitiBank est√° pensado para entornos educativos: los estudiantes tienen cuentas con las que pueden aprender a manejar dinero virtual. Los profesores (administradores) gestionan cuentas, pueden otorgar saldo inicial y ver reportes. El sistema garantiza que cada usuario tenga un perfil (`perfiles`) y una cuenta (`cuentas`) consistente creada en una operaci√≥n at√≥mica.

 **2) Arquitectura y stack**
 - Frontend: Next.js (App Router), TypeScript
 - UI: Tailwind CSS, shadcn/ui components
 - Backend: Supabase (Postgres), Supabase Auth
 - Edge Functions: Deno (Supabase Functions) para operaciones sensibles (creaci√≥n at√≥mica de usuarios, transacciones administrativas)
 - Despliegue: Vercel para la app Next.js; Supabase gestiona DB y funciones

 **3) Esquema de Base de Datos (resumen completo)**

 Ruta en repo para migraciones: `supabase/migrations/`

 Tablas principales (nombre / campos clave / notas):
 - `auth.users` (gesti√≥n de usuarios por Supabase Auth)
 - `perfiles` (perfil de usuario)
     - `id` uuid PRIMARY KEY REFERENCES `auth.users(id)`
     - `nombre_completo` text
     - `email` text
     - `rol` text CHECK (rol IN ('admin','cliente','otro')) ‚Äî control de autorizaci√≥n (simplificado)
     - `tipo` text CHECK (tipo IN ('alumno','padre','personal')) ‚Äî clasificaci√≥n del cliente dentro de la instituci√≥n
     - `created_at` timestamp
 - `cuentas` (cuentas bancarias)
     - `id` uuid PRIMARY KEY
     - `usuario_id` uuid REFERENCES `perfiles(id)` UNIQUE
     - `numero_cuenta` text UNIQUE ‚Äî generado v√≠a secuencia `numero_cuenta_seq`
     - `saldo` numeric (o decimal)
     - `created_at` timestamp
 - `transacciones`
     - `id` uuid PRIMARY KEY
     - `cuenta_id` uuid REFERENCES `cuentas(id)`
     - `tipo` text CHECK (tipo IN ('deposito','retiro','transferencia'))
     - `monto` numeric
     - `descripcion` text
     - `created_at` timestamp

 Relaciones/constraints importantes:
 - `cuentas.usuario_id` es UNIQUE y FK hacia `perfiles(id)`. Esto garantiza 1:1 perfil->cuenta.
 - `numero_cuenta` se genera mediante la secuencia `numero_cuenta_seq` y la funci√≥n RPC `create_account_for_user` que inserta la fila en `cuentas` de manera at√≥mica.

 **4) Migraciones y funciones almacenadas clave**
 - `001_create_numero_cuenta_seq_and_function.sql` ‚Äî crea `numero_cuenta_seq` y la funci√≥n `create_account_for_user(usuario_id uuid, saldo numeric)` que:
     - genera un `numero_cuenta` √∫nico basado en la secuencia,
     - inserta la cuenta con saldo inicial en una operaci√≥n at√≥mica,
     - devuelve la fila creada o lanza error si falla.
 - `002_add_tipo_to_perfiles_and_constraints.sql` ‚Äî a√±ade la columna `tipo` a `perfiles`, crea constraints y backfill (`tipo='alumno'` por defecto para registros existentes).

 Estas migraciones est√°n en `supabase/migrations/` y deben aplicarse en orden.

 **5) Edge Functions (Supabase)**
 Carpeta de funciones en repo: `supabase/functions/`

 Funciones m√°s importantes:
 - `crear-usuario-cliente` (`supabase/functions/crear-usuario-cliente/index.ts`)
     - Prop√≥sito: Proveer un √∫nico punto de creaci√≥n para:
         - crear el usuario en Supabase Auth,
         - insertar el `perfil` en `perfiles` (incluyendo `tipo` y `rol`),
         - invocar RPC `create_account_for_user` para crear la `cuenta` de forma at√≥mica,
         - registrar transacci√≥n inicial si aplica.
     - Seguridad: la funci√≥n usa `SUPABASE_SERVICE_ROLE_KEY` internamente; para operaciones administrativas puede requerir cabecera `x-admin-secret` o validaci√≥n de JWT que pertenezca a un `perfil` con rol admin.
     - Nota: Las llamadas p√∫blicas (registro desde UI) siempre crean cuentas con `saldo_inicial=0` y `tipo='alumno'` para evitar privilegios.

 - Otras funciones (por proyecto):
     - `gestionar-fondos` ‚Äî (si est√° presente) para operaciones administrativas de ajuste de saldo.
     - `iniciar-transferencia-cliente` ‚Äî inicia flujos de transferencia entre cuentas.

 **6) Frontend ‚Äî Estructura y p√°ginas completas**

 Carpeta principal: `src/app/`

 Rutas y p√°ginas (resumen):
 - `src/app/page.tsx` ‚Äî Landing p√∫blica.
 - `src/app/auth/`
     - `login/page.tsx` ‚Äî formulario de inicio de sesi√≥n.
     - `register/page.tsx` ‚Äî formulario de registro p√∫blico. Llama a la Edge Function `crear-usuario-cliente` para crear Auth + perfil + cuenta (saldo 0 para registros p√∫blicos).
     - `confirm/route.ts` ‚Äî endpoint de confirmaci√≥n (handlers de Supabase Auth callbacks).
     - `auth-code-error/page.tsx` ‚Äî p√°gina de error para flujos de OAuth o confirmaci√≥n.
 - `src/app/(cliente)/` ‚Äî rutas protegidas para clientes (estudiantes):
     - `dashboard/page.tsx` ‚Äî muestra saldo, actividad reciente.
     - `transferir/page.tsx` ‚Äî formulario para enviar dinero a otros estudiantes.
 - `src/app/admin/` ‚Äî panel de administraci√≥n (protegido por guardas/roles):
     - `page.tsx` ‚Äî admin dashboard con m√©tricas.
     - `configuracion/page.tsx` ‚Äî configuraci√≥n del banco/escuela.
     - `lista-alumnos/page.tsx` & `page-client.tsx` ‚Äî listado de estudiantes (client/server variants).
     - `nuevo-alumno/page.tsx` ‚Äî formulario para crear alumnos desde admin (invoca directamente la Edge Function `crear-usuario-cliente` usando el SDK de Supabase; ya no existe un proxy server-side por defecto).
 - `src/app/api/drive-scrape/route.ts` ‚Äî ejemplo de API route para scraping o integraci√≥n con Google Drive (puede ser un util interno).

 Componentes y utilidades clave (`src/components` y `src/lib`):
 - `src/components/admin-guard.tsx` y `client-guard.tsx` ‚Äî wrappers que protegen rutas seg√∫n rol.
 - `src/components/ui/*` ‚Äî componentes UI reutilizables (Button, Input, Table, Dialog, etc.) basados en shadcn/ui.
 - `src/lib/supabase/client.ts` ‚Äî crea el cliente Supabase para llamadas desde el cliente.
 - `src/lib/supabase/server.ts` ‚Äî cliente Supabase con credenciales server-side (service role) para llamadas en server code.
 - `src/lib/supabase/middleware.ts` ‚Äî middleware para verificar sesiones/roles en SSR/server routes.
 - `src/lib/supabase/database.types.ts` ‚Äî tipos TypeScript generados para tablas (incluye `perfiles.tipo`).

 **7) Configuraci√≥n y despliegue (Vercel & Supabase)**

 Recomendaci√≥n: desplegar la app Next.js en Vercel y las Edge Functions ya son desplegadas desde la carpeta `supabase/functions` usando la CLI o la integraci√≥n de Supabase.

 Variables de entorno (importantes):
 - Para Vercel (frontend):
     - `NEXT_PUBLIC_SUPABASE_URL` ‚Äî URL del proyecto Supabase.
     - `NEXT_PUBLIC_SUPABASE_ANON_KEY` ‚Äî anon public key (solo para client SDK).
 - Para server-side (Vercel/Server routes):
     - `SUPABASE_SERVICE_ROLE_KEY` ‚Äî clave con privilegios server (NO exponer al cliente).
    - `ADMIN_CREATE_SECRET` ‚Äî (opcional/legacy) secreto que se usaba cuando se proxyaba la llamada a trav√©s de un endpoint server-side. Con la llamada directa desde el admin UI a la Edge Function, este secreto no es estrictamente necesario; la funci√≥n valida Authorization Bearer tokens o `x-admin-secret` si configurado.
 - Para Supabase Functions (en el dashboard de Supabase):
     - `SUPABASE_URL`
     - `SUPABASE_ANON_KEY`
     - `SUPABASE_SERVICE_ROLE_KEY` (en variables de funci√≥n; necesario para crear usuarios y manipular DB)
    - `ADMIN_CREATE_SECRET` (opcional) ‚Äî si quieres que la Edge Function permita una segunda v√≠a de autenticaci√≥n administrativa basada en un secreto compartido (por ejemplo para proxies o sistemas externos), puedes configurar `ADMIN_CREATE_SECRET` en las variables de la funci√≥n. No es obligatorio cuando la UI usa el SDK y pasa Authorization Bearer tokens.

 Despliegue recomendado:
 1. Aplicar migraciones en Supabase (ordenadas): `supabase/migrations/001_...`, luego `002_...`.
 2. Desplegar Edge Functions con `supabase functions deploy crear-usuario-cliente --project-ref <ref>` o usando la UI.
 3. Desplegar Next.js a Vercel. Configurar variables de entorno en Vercel siguiendo las claves indicadas.

 **8) Desarrollo local**

 Requisitos:
 - Node.js (versi√≥n usada en proyecto, ver `package.json`), npm >= 8
 - Acceso a un proyecto Supabase (URL + anon/service role keys)

 Pasos r√°pidos:
 - Instala dependencias:
 ```powershell
 npm install
 ```
 - Variables locales: crea un `.env.local` con:
 ```
 NEXT_PUBLIC_SUPABASE_URL=<your_supabase_url>
 NEXT_PUBLIC_SUPABASE_ANON_KEY=<your_anon_key>
 SUPABASE_SERVICE_ROLE_KEY=<your_service_role_key>
# ADMIN_CREATE_SECRET is optional and only needed if you use a proxy flow
# ADMIN_CREATE_SECRET=<random_secret_for_admin_calls>
 ```
 - Desarrollar en local:
 ```powershell
 npm run dev
 ```
 - Build de producci√≥n:
 ```powershell
 npm run build
 npm run start
 ```

 **9) Notas operativas y seguridad**
 - Nunca expongas `SUPABASE_SERVICE_ROLE_KEY` ni `ADMIN_CREATE_SECRET` en clientes.
 - Las llamadas administrativas deben pasar por una ruta server-side que valide la sesi√≥n y reenv√≠e la petici√≥n a la funci√≥n con el secreto.
 - Las registraciones p√∫blicas se limitan a `tipo='alumno'` y `saldo_inicial=0`.

 --

 Ap√©ndice: Estructura del repo (resumen)
 ```
 .
 ‚îú‚îÄ public/
 ‚îú‚îÄ src/
 ‚îÇ  ‚îú‚îÄ app/
 ‚îÇ  ‚îÇ  ‚îú‚îÄ (admin)/
 ‚îÇ  ‚îÇ  ‚îú‚îÄ (cliente)/
 ‚îÇ  ‚îÇ  ‚îú‚îÄ auth/
 ‚îÇ  ‚îÇ  ‚îú‚îÄ api/
 ‚îÇ  ‚îÇ  ‚îî‚îÄ page.tsx
 ‚îÇ  ‚îú‚îÄ components/
 ‚îÇ  ‚îî‚îÄ lib/
 ‚îú‚îÄ supabase/
 ‚îÇ  ‚îú‚îÄ functions/
 ‚îÇ  ‚îî‚îÄ migrations/
 ‚îú‚îÄ package.json
 ‚îî‚îÄ README.md (este archivo)
 ```

 Si quieres, puedo:
 - Expandir la secci√≥n de esquema de la base de datos con los SQL exactos de cada migraci√≥n (copiar/pegar el contenido de `supabase/migrations/*`).
 - A√±adir una secci√≥n de troubleshooting con errores comunes y c√≥mo verificarlos en Supabase.
 - Crear un archivo `DEVELOPMENT.md` con pasos de despliegue automatizados.

 ¬øQu√© prefieres que a√±ada a continuaci√≥n? (Puedo incluir las migraciones completas y describir cada columna y constraint en detalle.)

**Anexo C ‚Äî Descripci√≥n de p√°ginas, rutas y componentes (detallado)**

Carpeta principal: `src/app`

P√°ginas y rutas (archivo ‚Üí descripci√≥n):
- `page.tsx` ‚Äî Landing page p√∫blica del sitio (presentaci√≥n y enlaces a login/register).
- `auth/login/page.tsx` ‚Äî Formulario de inicio de sesi√≥n que usa el cliente Supabase para autenticar.
- `auth/register/page.tsx` ‚Äî Formulario p√∫blico de registro. Llama a la Edge Function `crear-usuario-cliente` para crear Auth + perfil + cuenta con `saldo_inicial=0`.
- `auth/confirm/route.ts` ‚Äî Endpoint para manejar confirmaciones de email / callbacks seg√∫n implementaci√≥n de Supabase Auth.
- `auth/auth-code-error/page.tsx` ‚Äî P√°gina para mostrar errores de flujo de autenticaci√≥n.
- `documentos/page.tsx` ‚Äî P√°gina p√∫blica que muestra documentos o pol√≠ticas del banco escolar.

Rutas protegidas por roles (agrupadas):
- `(cliente)/dashboard/page.tsx` ‚Äî Dashboard del estudiante: saldo, movimientos recientes.
- `(cliente)/dashboard/transferir/page.tsx` ‚Äî Interfaz para realizar transferencias entre cuentas.

- `admin/page.tsx` ‚Äî Dashboard administrativo con m√©tricas clave.
- `admin/configuracion/page.tsx` ‚Äî Ajustes y configuraci√≥n del sistema para administradores.
- `admin/lista-alumnos/page.tsx` ‚Äî Listado server-side de alumnos.
- `admin/lista-alumnos/page-client.tsx` ‚Äî Variante client-side del listado (para b√∫squedas/filtrado din√°mico).
- `admin/nuevo-alumno/page.tsx` ‚Äî Formulario para que un admin cree alumnos con `saldo_inicial` y `tipo`.

API routes y funciones server-side en `src/app/api/`:
- `api/admin/crear-usuario/route.ts` ‚Äî Endpoint server that validates requester role and forwards creation request to the Edge Function using `ADMIN_CREATE_SECRET`.
- `api/drive-scrape/route.ts` ‚Äî Example integration API route (scraping/drive import).

Componentes principales (`src/components`):
- `admin-guard.tsx` ‚Äî Wrapper to protect admin routes; valida sesi√≥n y rol.
- `client-guard.tsx` ‚Äî Wrapper para rutas de clientes.
- `admin-navigation.tsx` ‚Äî Navegaci√≥n lateral/top para el panel de administraci√≥n.

UI primitives (`src/components/ui`):
- `button.tsx`, `input.tsx`, `label.tsx`, `card.tsx`, `dialog.tsx`, `alert.tsx`, `table.tsx` ‚Äî componentes estilizados con Tailwind y utilidades compartidas.

L√≥gica y helpers (`src/lib`):
- `supabase/client.ts` ‚Äî Crea el cliente Supabase para uso en el navegador (usa `NEXT_PUBLIC_SUPABASE_*`).
- `supabase/server.ts` ‚Äî Cliente server-side con soporte para cookies y SSR.
- `supabase/middleware.ts` ‚Äî Helpers/middleware para validar sesiones y roles.
- `supabase/database.types.ts` ‚Äî Tipos TypeScript generados para las tablas p√∫blicas (`perfiles`, `cuentas`, `transacciones`, funciones como `realizar_transferencia`).

Supabase Functions (`supabase/functions/`):
- `crear-usuario-cliente/` ‚Äî Edge Function para creaci√≥n at√≥mica de usuario+perfil+cuenta.
- `gestionar-fondos/`, `iniciar-transferencia-cliente/` ‚Äî otras funciones relacionadas con transacciones y flujos (si existen en repo).

Con esto ya tienes un README que cubre los puntos principales: visi√≥n, arquitectura, DB, migraciones, funciones y frontend. Puedo ahora:
- A√±adir SQL completo de cada migraci√≥n como ap√©ndice.
- Generar un `DEVELOPMENT.md` para pasos de despliegue y verificaci√≥n (incluye comandos `supabase` y `vercel`).
- Crear un checklist de operaciones para producci√≥n (aplicar migraciones, desplegar functions, configurar variables en Vercel).

Indica cu√°l prefieres que haga a continuaci√≥n y lo continuo.


**10) Frontend ‚Äî Paquetes y versiones (resumen)**

Las dependencias principales est√°n en `package.json`. Resumen de las m√°s relevantes:

- `next`: 15.3.4
- `react`: ^19.0.0
- `@supabase/supabase-js`: ^2.57.2 (SDK de Supabase para cliente/servidor)
- `@supabase/ssr`: ^0.7.0 (helper SSR para Supabase si se requiere)
- `tailwindcss`: ^4 (devDependency)
- `lucide-react`: ^0.468.0 (icon set)
- `class-variance-authority`, `clsx`, `tailwind-merge` ‚Äî utilidades para clases y estilos

Dev dependencies clave:
- `typescript`: ^5
- `eslint` + `eslint-config-next` (alineado a Next.js 15)

Scripts √∫tiles (desde la ra√≠z del proyecto):
```powershell
npm install
npm run dev    # corre la app en modo desarrollo
npm run build  # crea build de producci√≥n
npm run start  # inicia servidor en modo producci√≥n
npm run lint   # corre linter (ESLint)
```

Consejo: la app usa el cliente Supabase tanto en cliente como server ‚Äî revisa `src/lib/supabase/*` para ver c√≥mo se crean las instancias y d√≥nde se usan las keys p√∫blicas vs service-role.


--

**Anexo A ‚Äî Migraciones y detalles SQL**

En `supabase/migrations/` est√°n las migraciones aplicadas por el proyecto. A continuaci√≥n se resumen las dos migraciones principales que se han a√±adido:

- `001_create_numero_cuenta_seq_and_function.sql` (resumen):
    - Crea una secuencia `public.numero_cuenta_seq` iniciando en `1000000000` si no existe.
    - Ajusta el valor de la secuencia para evitar colisiones con `numero_cuenta` existentes.
    - Define la funci√≥n `public.generate_numero_cuenta()` que devuelve un `text` de 10 d√≠gitos usando la secuencia.
    - Define `public.create_account_for_user(p_usuario_id uuid, p_saldo numeric)` que inserta una fila en `public.cuentas` con un `numero_cuenta` √∫nico y devuelve la fila creada. Esta RPC proporciona atomicidad al crear cuentas.

- `002_add_tipo_to_perfiles_and_constraints.sql` (resumen):
    - A√±ade la columna `tipo text NOT NULL DEFAULT 'alumno'` a `public.perfiles`.
    - A√±ade una constraint `rol_valido` para garantizar `rol IN ('cliente','personal','admin')`.
    - A√±ade una constraint `tipo_valido` para garantizar `tipo IN ('alumno','padre','personal')`.
    - Ejecuta un `UPDATE` para backfill: `UPDATE public.perfiles SET tipo = 'alumno' WHERE tipo IS NULL OR tipo = '';`

Estas migraciones deben aplicarse con el CLI de Supabase (`supabase db push` o `psql`) en el entorno de producci√≥n.

**Anexo B ‚Äî Edge Function `crear-usuario-cliente` (resumen de implementaci√≥n)**

Archivo: `supabase/functions/crear-usuario-cliente/index.ts`

Flujo principal que implementa la funci√≥n:
1. Validaci√≥n CORS y manejo de `OPTIONS`.
2. Construcci√≥n de cliente `supabaseAdmin` usando `SUPABASE_URL` y `SUPABASE_SERVICE_ROLE_KEY` desde las env vars de la funci√≥n.
3. Lectura del body con campos: `nombre_completo`, `email`, `password`, `saldo_inicial`, `rol`, `tipo`.
4. Determinaci√≥n si la llamada proviene de un administrador:
     - Comprueba cabecera `x-admin-secret` frente a `ADMIN_CREATE_SECRET`.
     - Si no hay secreto, intenta validar `Authorization: Bearer <token>` consultando `/auth/v1/user` y verificando el rol en `perfiles`.
5. Si la llamada NO es admin, fuerza `saldo_inicial = 0`, `rol = 'cliente'` y `tipo = 'alumno'`.
6. Crea el usuario en Supabase Auth con `supabaseAdmin.auth.admin.createUser(...)` (marca email_confirm true para evitar email pendiente en entorno educativo).
7. Inserta fila en `perfiles` con `id` = `auth.user.id`, `nombre_completo`, `rol` y `tipo`.
8. Intenta invocar la RPC `create_account_for_user` para crear la cuenta de forma at√≥mica; si falla, hace un fallback con inserciones en `cuentas` intentando generar `numero_cuenta` con retries.
9. Si `saldo_inicial > 0` registra una transacci√≥n inicial en `transacciones`.
10. Devuelve 201 en caso de √©xito con `{ userId, message }`, o 400 con `{ error }` en error.

Nota de seguridad: la funci√≥n requiere `SUPABASE_SERVICE_ROLE_KEY` en sus env vars; en producci√≥n aseg√∫rate de guardarla en el dashboard de Supabase y no en el repositorio.

